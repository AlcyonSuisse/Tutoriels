# Creer une image
Nous avons plusieurs façon de faire une image. Nous pouvons le faire à partir d'un conteneur existant, facile à mettre en place, mais compliqué à maintenir. From scratch, complexe, et difficile à maintenir. Puis via un dockerfile, un fichier qui comporte les instructions de la création de l'image (la recette), en ce basant sur une image existante, c'est la meilleur méthode, et c'est facile à maintenir.

Dans cette partie nous créerons des images avec un dockerfile, car c'est la méthode la plus rapide et simple à maintenir.


## Création d'un Dockerfile
### Créons une image apache
Le Dockerfile (toujours avec une majuscule) est un fichier qui contient toutes les informations pour créer une image, comme des métadonnées (Mainteneur, label etc ...), ou même les commandes à exécuter pour installer un logiciel.


Voici la liste des instructions d'un Dockerfile :
```shell
FROM # Pour choisir l'image sur laquel on ce base, toujours en premier
MAINTAINER # Le nom du createur/mainteneur sous forme "prenom nom [ou pseudo] <email>" 
RUN # Permets d'exécuter une commande
CMD # Commande exécuter au démarrage du conteneur par défaut
EXPOSE # Ouvres un port
ENV # Permets d'éditer des variables d'environnement
ARG # Un peu comme ENV, mais seulement le temps de la construction de l'image
COPY # Permets de copier un fichier ou répertoire de l'hôte vers l'image
ADD # Permets de copier un fichier de l'hôte ou depuis une URL vers l'image, permets également de décompresser une archive tar
LABEL # Des métadonnées utile pour certain logiciel de gestion de conteneur, comme rancher ou swarm, ou tout simplement pour mettre des informations sur l'image.
ENTRYPOINT # Commande exécuter au démarrage du conteneur, non modifiable, utilisé pour package une commande
VOLUME # Crée une partition spécifique
```

Et la commande pour construire l'image :
```shell
docker build -t [imagename]:[tag] [dockerfile folder]
```

Pour pouvoir construire une image, il faut connaitre un minimum le logiciel que l'on souhaite conteneuriser, par exemple ici je vais conteneuriser apache, et je sais qu'il lui faut certaines variables d'environnements pour fonctionner.
On commence par créer le répertoire de notre projet :
```shell
$ mkdir /home/xataz/superapache
$ cd /home/xataz/superapache
$
```

Puis on crée notre Dockerfile (le D en majuscule) :
```shell
$ vim Dockerfile
```

On commence par mettre le FROM, MAINTAINER :
```shell
FROM debian
MAINTAINER xataz <xataz@mondomaine.dev>
```

Puis on ajoute les variables d'environnements (qui sont normalement gérer par le système d'init) :
```shell
ENV APACHE_RUN_USER www-data
ENV APACHE_RUN_GROUP www-data
ENV APACHE_LOG_DIR /var/web/log/apache2
ENV APACHE_PID_FILE /var/run/apache2.pid
ENV APACHE_RUN_DIR /var/run/apache2
ENV APACHE_LOCK_DIR /var/lock/apache2
```

On installe apache :
```shell
RUN export DEBIAN_FRONTEND=noninteractive && apt-get update && apt-get -y -q upgrade && apt-get -y -q install apache2
```

On expose les ports (facultatifs) :
```shell
EXPOSE 80 443
```

Et pour finir, on ajoute la commande par défaut :
```shell
CMD ["apache2ctl","-D","FOREGROUND"]
```


le Dockerfile au complet :
```shell
FROM ubuntu
MAINTAINER xataz <xataz@mondomaine.fr>

ENV APACHE_RUN_USER www-data
ENV APACHE_RUN_GROUP www-data
ENV APACHE_LOG_DIR /var/web/log/apache2
ENV APACHE_PID_FILE /var/run/apache2.pid
ENV APACHE_RUN_DIR /var/run/apache2
ENV APACHE_LOCK_DIR /var/lock/apache2

RUN export DEBIAN_FRONTEND=noninteractive && apt-get update && apt-get -y -q upgrade && apt-get -y -q install apache2

EXPOSE 80 443

CMD ["apache2ctl","-D","FOREGROUND"]
```

Puis on construit notre image :
```shell
$ docker build -t xataz/superapache .
Sending build context to Docker daemon 3.072 kB
Step 0 : FROM debian
latest: Pulling from library/ubuntu
d3a1f33e8a5a: Pull complete
c22013c84729: Pull complete
d74508fb6632: Pull complete
91e54dfb1179: Pull complete
[...]
Step 10 : CMD apache2ctl -D FOREGROUND
---> Running in d435f9e2db87
---> 1f9e7590d11b
Removing intermediate container d435f9e2db87
Successfully built 1f9e7590d11b
```

On peux la tester :

### Exemple d'une image wallabag

### Créons une image de base

## Les bonnes pratiques
### Limiter les layers
### Utiliser une image de base light
